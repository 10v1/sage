# Use minimal Ubuntu installation that includes mamba
image: condaforge/mambaforge

# We use the following layout:
#
# $HOME/sage            Source tree used by the Docker build; see SAGE_ROOT/tox.ini (gitpod).
#                       - We delete it in every invocation of the 'before' script
#                         and replace it by a symlink to /workspace/...
#                         (This symlink is needed because the package-removal scripts
#                         ({prefix,venv}/var/lib/sage/scripts/*/{spkg-piprm,spkg-prerm,spkg-postrm)
#                         hardcode SAGE_ROOT and SAGE_SRC from package installation time)
# $HOME/sage/logs       Logs of the Docker build.
#                       - In the first invocation of the 'before' script, we move it
#                         to /workspace/.../logs
# $HOME/sage-local      The configured prefix (SAGE_LOCAL) of the Sage installation.
#                       - During the Docker build, this is the physical location.
#                       - In the first invocation of the 'before' script, we move it
#                         to the new physical location /workspace/.../local
#                         (because gitpod only preserves the contents of /workspace)
#                         and replace it by a symlink to the new physical location.
#                       - In subsequent invocations of the 'before' script, we
#                         remove it and replace it by a symlink to the physical
#                         location /workspace/.../local
# /worktree/.../local   The physical location of the Sage installation,
#                       established in the first run of the 'before' script and
#                       preserved by gitpod.

# Start up tasks. https://www.gitpod.io/docs/config-start-tasks/
tasks:
  - name: Setup
    before: |
      # Create conda environment
      mamba env create --file src/environment-dev.yml --prefix venv
      conda activate /workspace/sagetrac-mirror/venv

      # Setup trac as remote
      ## In order to push to trac, generate a new key with `ssh-keygen -f tempkey` and save the private key to gitpod `gp env PRIVATE_SSH_KEY="$(<tempkey)"` (or by following https://www.gitpod.io/docs/environment-variables#using-the-account-settings)
      ## then follow https://doc.sagemath.org/html/en/developer/trac.html#linking-your-public-key-to-your-trac-account to register the public key with trac.
      ## Afterwards, create a new gitpod workspace.
      git remote remove trac 2> /dev/null # might still exists from a previous run/prebuild
      if [[ -n "${PRIVATE_SSH_KEY}" ]]; then
        # Setup ssh key for authentication with trac
        mkdir -p ~/.ssh
        echo $PRIVATE_SSH_KEY | sed 's/\(-----\(BEGIN\|END\) OPENSSH PRIVATE KEY-----\)/\n\1\n/g' > ~/.ssh/id_rsa
        sed -i '/^$/d' ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        unset PRIVATE_SSH_KEY
        ssh-keyscan -H trac.sagemath.org >> ~/.ssh/known_hosts

        # Setup trac repo
        git remote add trac git@trac.sagemath.org:sage.git -t master -t develop -t $(git branch --show-current)
        git remote set-url --push trac git@trac.sagemath.org:sage.git
        git fetch trac
        git branch -u trac/$(git branch --show-current)
      else
        # Fallback to sagemath mirror
        git remote add trac https://github.com/sagemath/sagetrac-mirror.git -t master -t develop
        git remote set-url --push trac pushing-needs-ssh-key
      fi
      
      ## No need for pyenv
      pyenv shell --unset 2> /dev/null
      pyenv global system 2> /dev/null

      # Build sage
      ./bootstrap
      ./configure --enable-build-as-root --with-python=$CONDA_PREFIX/bin/python --prefix=$CONDA_PREFIX 
      pip install --no-build-isolation -v -v -e pkgs/sage-conf pkgs/sage-setup 
      pip install --no-build-isolation -v -v -e src

    env:
      SAGE_NUM_THREADS: 8

# Preinstalled VS Code extensions. https://www.gitpod.io/docs/vscode-extensions
vscode:
  extensions:
    - ms-pyright.pyright
    - ms-python.python
    - trond-snekvik.simple-rst
    - lextudio.restructuredtext
    - streetsidesoftware.code-spell-checker
    - ms-toolsai.jupyter

# https://www.gitpod.io/docs/prebuilds#github-specific-configuration
github:
  prebuilds:
    # enable for the default branch (defaults to true)
    master: true
    # enable for all branches in this repo (defaults to false)
    branches: true
    # enable for pull requests coming from this repo (defaults to true)
    pullRequests: true
    # enable for pull requests coming from forks (defaults to false)
    pullRequestsFromForks: true
    # add a check to pull requests (defaults to true)
    addCheck: true
    # add a "Review in Gitpod" button as a comment to pull requests (defaults to false)
    addComment: true
    # add a "Review in Gitpod" button to the pull request's description (defaults to false)
    addBadge: true
